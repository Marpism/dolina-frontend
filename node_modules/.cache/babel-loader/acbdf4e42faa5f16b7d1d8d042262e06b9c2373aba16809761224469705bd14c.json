{"ast":null,"code":"import{useEffect,useState}from'react';import'./App.css';import MainPage from'./pages/MainPage';import CatalogPage from'./pages/CatalogPage';// import NewPage from './pages/NewPage';\n// import SalePage from './pages/SalePage';\nimport ProductPage from'./pages/ProductPage';import ContactPage from'./pages/ContactPage';import RegisterForm from'./Form/RegisterForm';import LoginForm from'./Form/LoginForm';import ShoppingCart from'./ShoppingCart/ShoppingCart';import{CurrentUserContext}from'../contexts/CurrentUserContext';import Wishlist from'./Profile/Wishlist';import ProtectedRoute from'./ProtectedRoute';import productsApi from'../utils/Api';import usersApi from'../utils/UsersApi';import NotFoundPage from'./NotFoundPage/NotFoundPage';import Profile from'./Profile/Profile';import Orders from'./Profile/Orders';import{Route,Routes,useNavigate,NavLink,useLocation,useSearchParams}from'react-router-dom';import BurgerMenu from'./Header/BurgerMenu/BurgerMenu';import MobileNavBar from'./MobileNavBar/MobileNavBar';import OrderingPage from'./ShoppingCart/OrderingPage/OrderingPage';import Header from'./Header/Header';import Footer from'./Footer/Footer';import LicensePage from'./pages/LicensePage';import AboutPage from'./pages/AboutPage';import SuccessPage from'./ShoppingCart/SuccessPage/SuccessPage';import ScrollToTop from'./ScrollToTop';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function App(){const navigate=useNavigate();const location=useLocation();const[pageTitle,setPageTitle]=useState('Долина Самоцветов');const[productData,setProductData]=useState([]);const[products,setProducts]=useState([]);const[inputError,setInputError]=useState('');const[isLoggedIn,setIsLoggedIn]=useState(localStorage.getItem('jwt')?true:false);const[currentUser,setCurrentUser]=useState({});const[savedProducts,setSavedproducts]=useState([]);const[orders,setOrders]=useState([]);const[cart,setCart]=useState([]);const[isProfilePopupOpen,setIsProfilePopupOpen]=useState(false);const[terms,setTerms]=useState([]);const searchParams=new URLSearchParams(location.search);const[category,setCategory]=useState('');const[tags,setTags]=useState('');const[search,setSearch]=useState('');const[isBurgerOpen,setIsBurgerOpen]=useState(false);// console.log(isBurgerOpen)\nconst categoryQuery=searchParams.get('category');const tagsQuery=searchParams.get('tags');const colorsQuery=searchParams.get('colors');const searchQuery=searchParams.get('search');const[productFilters,setProductFilters]=useState({category:categoryQuery!==null&&categoryQuery!==void 0?categoryQuery:'',tags:tagsQuery?tagsQuery.split(',').map(id=>parseInt(id)):[],colors:colorsQuery?colorsQuery.split(',').map(id=>parseInt(id)):[],search:searchQuery!==null&&searchQuery!==void 0?searchQuery:'',sortBy:'default',offset:0,pageSize:24,seed:Math.floor(Math.random()*99999)});useEffect(()=>{document.title=pageTitle;},[pageTitle]);const[offset,setOffset]=useState(0);const pageSize=24;const[sortBy,setSortBy]=useState('');const[sortOrder,setSortOrder]=useState('');const[lastProductsRequest,setLastProductsRequest]=useState(0);const[isLoadingMore,setIsLoadingMore]=useState(false);const[showLoadMore,setShowLoadMore]=useState(false);const[catalogLoading,setCatalogLoading]=useState(false);// console.log(productFilters)\nfunction handleBurgerOpening(){setIsBurgerOpen(true);}function handleBurgerClosing(){setIsBurgerOpen(false);}function handleLogin(email,password){setInputError('');usersApi.login(email,password).then(()=>{setIsLoggedIn(true);navigate('/');}).catch(err=>{if(err.status===401){setInputError('Неправильный логин или пароль');}else{setInputError('При авторизации произошла ошибка');}});}// console.log(products)\nfunction handleRegistration(name,email,password){setInputError('');usersApi.register(name,email,password).then(()=>{handleLogin(email,password);}).catch(err=>{if(err.status===409){setInputError('Пользователь с таким email уже существует');}else{setInputError('При регистрации пользователя произошла ошибка');}});}function handleSignOut(){setIsProfilePopupOpen(false);setIsLoggedIn(false);localStorage.removeItem('jwt');navigate('/signin');}function handleUpdateUser(e){usersApi.updateUserData(e).then(res=>setCurrentUser(res));setIsProfilePopupOpen(false);}function handleChangeClick(){// console.log(isProfilePopupOpen)\nsetIsProfilePopupOpen(true);}function handleClosePopupClick(){// console.log(isProfilePopupOpen)\nsetIsProfilePopupOpen(false);}// КОРЗИНА\nuseEffect(()=>{const savedCart=JSON.parse(localStorage.getItem('cart'));if(savedCart)setCart(savedCart);},[]);function handleAddToCart(productId,checked,size){const newCart={...cart};newCart[productId]={checked,size};// это типа как эррэй\nsetCart(newCart);if(isLoggedIn){// console.log(newCart)\n// патчим в корзину юзера\nusersApi.updateCart(JSON.stringify(newCart));}localStorage.setItem('cart',JSON.stringify(newCart));}function handleRemoveFromCart(productId){const newCart={...cart};delete newCart[productId];setCart(newCart);if(isLoggedIn){usersApi.updateCart(JSON.stringify(newCart));}localStorage.setItem('cart',JSON.stringify(newCart));}// переход в товар\nfunction handleCardClick(newSlug){console.log('хэндлер сработал, хотя не должен был');}// лайк\nfunction handleLikeClick(id){if(isLoggedIn){if(savedProducts.includes(id)){usersApi.removeProduct(id).then(()=>{setSavedproducts(savedProducts.filter(item=>item!==id));}).catch(err=>console.log(err));}else{usersApi.saveProduct(id).then(()=>{setSavedproducts([id,...savedProducts]);}).catch(err=>console.log(err));}}else{navigate('/signin');}}// Аутентификация, ставит current-юзера, корзину\nuseEffect(()=>{const token=localStorage.getItem('jwt');const savedCart=JSON.parse(localStorage.getItem('cart'));if(token){usersApi.checkToken(token).then(user=>{setCurrentUser(user);setIsLoggedIn(true);let userCart=JSON.parse(user.cart);if(savedCart)Object.assign(userCart,savedCart);usersApi.updateCart(userCart);setCart(userCart);if(JSON.stringify(userCart)!==JSON.stringify(savedCart)){localStorage.setItem('cart',JSON.stringify(userCart));}}).catch(err=>console.error('Ошибка:',err));}},[]);// ставит избранное и заказы\nuseEffect(()=>{if(isLoggedIn){usersApi.getUsersProfile().then(data=>{setSavedproducts(data[0]);setOrders(data[1]);setCurrentUser(data[2]);// handleCategorySelection('');\n// console.log(data)\n})// .then(() => handleCategorySelection(''))\n.catch(err=>{console.log(err);});}},[isLoggedIn]);// Получаем продукты и рендерим товары\n//   useEffect(() => {\n//     productsApi.getAllProducts()\n//       .then((data) => {\n//         console.log(data);\n//         setProducts(data);\n//       }).catch((err) => {\n//         console.log(err);\n//       })\n//   }, []) // когда в скобках products, запросы идут бесконечно. Почему?\n// console.log(currentUser)\n// РУБРИКИ\nuseEffect(()=>{productsApi.getTerms().then(data=>{setTerms(data);}).catch(err=>{console.log(err);});},[]);// useEffect(() => {\n//   console.log(products)\n// }, [products])\n// useEffect(() => {\n//   if (search.length > 0) {\n//     setProductFilters(prevFilters => ({\n//       ...prevFilters,\n//       category: '',\n//       tags: [],\n//       search: search\n//     }));\n//   }\n// }, [search]);\nfunction fetchProducts(){if(productFilters.offset>0){setIsLoadingMore(true);}else{setCatalogLoading(true);}productsApi.filterProducts(productFilters.category,productFilters.tags,productFilters.search,productFilters.offset,productFilters.pageSize,productFilters.sortBy,productFilters.seed,productFilters.colors).then(data=>{if(data.length>productFilters.pageSize){setShowLoadMore(true);}else{setShowLoadMore(false);}if(productFilters.offset>0){setProducts(prevProducts=>[...prevProducts,...data.slice(0,productFilters.pageSize)]);setIsLoadingMore(false);}else{setProducts(data.slice(0,productFilters.pageSize));setCatalogLoading(false);}}).catch(err=>{console.log(err);});};useEffect(()=>{// обновляем url просто\nif(window.location.pathname.includes(\"catalog\")){// kolkhoz\nif(productFilters.category){// setProducts([]);\nsearchParams.set('category',productFilters.category);}else{searchParams.delete('category');}if(productFilters.tags.length>0){// setProducts([]);\nsearchParams.set('tags',productFilters.tags);}else{searchParams.delete('tags');}if(productFilters.colors.length>0){// setProducts([]);\nsearchParams.set('colors',productFilters.colors);}else{searchParams.delete('colors');}if(productFilters.search){// setProducts([]);\nsearchParams.set('search',productFilters.search);}else{searchParams.delete('search');}let newPath='/catalog/?'+searchParams.toString();if(newPath!=window.location.pathname+window.location.search)navigate(newPath);fetchProducts();}},[productFilters]);function handleCategorySelection(categoryId){// setProducts([]);\nsetProductFilters(prevFilters=>({...prevFilters,category:categoryId,tags:[],colors:[],search:'',offset:0}));if(categoryId){navigate('/catalog/?category='+categoryId);}else{navigate('/catalog/');}}function handleTagSelection(activeTags){// setProducts([]);\nsetProductFilters(prevFilters=>({...prevFilters,tags:activeTags,search:'',offset:0}));}function handleColorSelection(activeColors){// setProducts([]);\nsetProductFilters(prevFilters=>({...prevFilters,colors:activeColors,search:'',offset:0}));}const showHeader=location.pathname!=='/ordering'&&!location.pathname.includes('/administration');return/*#__PURE__*/_jsx(CurrentUserContext.Provider,{value:currentUser,children:/*#__PURE__*/_jsxs(\"div\",{className:\"page\",children:[!window.location.pathname.includes(\"administration\")&&/*#__PURE__*/_jsx(\"div\",{className:\"header_block_1\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"header__container\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(NavLink,{to:\"/about\",className:\"navlink_size_s color_white\",children:\"\\u041E \\u043D\\u0430\\u0441\"}),/*#__PURE__*/_jsx(NavLink,{to:\"/contacts\",className:\"navlink_size_s color_white\",children:\"\\u041A\\u043E\\u043D\\u0442\\u0430\\u043A\\u0442\\u044B\"})]}),/*#__PURE__*/_jsx(\"p\",{className:\".navlink_size_s color_white\",children:\"8 800 200 17 05\"})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"content\",children:[showHeader&&/*#__PURE__*/_jsx(Header,{terms:terms,onCatClick:handleCategorySelection,activeCategory:category,isBurgerOpen:isBurgerOpen,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing,search:search,setSearch:setSearch,cart:cart,orders:orders,productFilters:productFilters,setProductFilters:setProductFilters}),/*#__PURE__*/_jsx(ScrollToTop,{}),/*#__PURE__*/_jsxs(Routes,{children:[/*#__PURE__*/_jsx(Route,{path:\"/\",element:/*#__PURE__*/_jsx(MainPage,{onCardClick:handleCardClick,onLikeClick:handleLikeClick,products:products,setProducts:setProducts,savedProducts:savedProducts,isLoggedIn:isLoggedIn,terms:terms,onCatClick:handleCategorySelection,category:category,cart:cart,orders:orders,fetchProducts:fetchProducts,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/contacts\",element:/*#__PURE__*/_jsx(ContactPage,{terms:terms,onCatClick:handleCategorySelection,category:category,cart:cart,orders:orders,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/license\",element:/*#__PURE__*/_jsx(LicensePage,{terms:terms,onCatClick:handleCategorySelection,category:category,cart:cart,orders:orders,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/about\",element:/*#__PURE__*/_jsx(AboutPage,{terms:terms,onCatClick:handleCategorySelection,category:category,cart:cart,orders:orders,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/me/orders/success/:orderId?\",element:/*#__PURE__*/_jsx(SuccessPage,{terms:terms,onCatClick:handleCategorySelection,category:category,cart:cart,orders:orders,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/catalog/\",element:/*#__PURE__*/_jsx(CatalogPage,{onCardClick:handleCardClick,onLikeClick:handleLikeClick,products:products,setProducts:setProducts,savedProducts:savedProducts,isLoggedIn:isLoggedIn,terms:terms,category:category,tags:tags,onCatClick:handleCategorySelection,onTagClick:handleTagSelection,onColorClick:handleColorSelection,cart:cart,orders:orders,sortBy:sortBy,setSortBy:setSortBy,sortOrder:sortOrder,setSortOrder:setSortOrder,fetchProducts:fetchProducts,onBurgerClick:handleBurgerOpening,productFilters:productFilters,setProductFilters:setProductFilters,onBurgerClose:handleBurgerClosing,isLoadingMore:isLoadingMore,showLoadMore:showLoadMore,catalogLoading:catalogLoading})}),/*#__PURE__*/_jsx(Route,{path:\"/product/:newSlug\",element:/*#__PURE__*/_jsx(ProductPage,{productData:productData,onLikeClick:handleLikeClick,savedProducts:savedProducts,isLoggedIn:isLoggedIn,onAddClick:handleAddToCart,cart:cart,orders:orders,onCardClick:handleCardClick,terms:terms,onCatClick:handleCategorySelection,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/signup\",element:/*#__PURE__*/_jsx(RegisterForm,{onRegistration:handleRegistration,inputError:inputError,terms:terms,category:category,onCatClick:handleCategorySelection})}),/*#__PURE__*/_jsx(Route,{path:\"/signin\",element:/*#__PURE__*/_jsx(LoginForm,{onLogin:handleLogin,inputError:inputError,terms:terms,category:category,onCatClick:handleCategorySelection})}),/*#__PURE__*/_jsx(Route,{path:\"/me\",element:/*#__PURE__*/_jsx(ProtectedRoute,{isLoggedIn:isLoggedIn,element:Profile,onUpdateUser:handleUpdateUser,onSignout:handleSignOut,onChangeClick:handleChangeClick,onCloseClick:handleClosePopupClick,savedProducts:savedProducts,orders:orders,cart:cart,isPopupOpen:isProfilePopupOpen,terms:terms,category:category,onCatClick:handleCategorySelection,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/me/orders\",element:/*#__PURE__*/_jsx(ProtectedRoute,{isLoggedIn:isLoggedIn,orders:orders,element:Orders,terms:terms,category:category,onCatClick:handleCategorySelection,cart:cart,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing,isBurgerOpen:isBurgerOpen})}),/*#__PURE__*/_jsx(Route,{path:\"/me/wishlist\",element:/*#__PURE__*/_jsx(ProtectedRoute,{isLoggedIn:isLoggedIn,element:Wishlist,onCardClick:handleCardClick,onLikeClick:handleLikeClick,savedProducts:savedProducts,terms:terms,category:category,onCatClick:handleCategorySelection,cart:cart,orders:orders,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/cart\",element:/*#__PURE__*/_jsx(ShoppingCart,{cart:cart,onCardClick:handleCardClick,isLoggedIn:isLoggedIn,onRemoveClick:handleRemoveFromCart,savedProducts:savedProducts,onLikeClick:handleLikeClick,terms:terms,category:category,onCatClick:handleCategorySelection,orders:orders,onBurgerClick:handleBurgerOpening,onBurgerClose:handleBurgerClosing})}),/*#__PURE__*/_jsx(Route,{path:\"/ordering\",element:/*#__PURE__*/_jsx(OrderingPage,{cart:cart,onCatClick:handleCategorySelection// onCardClick={handleCardClick}\n,isLoggedIn:isLoggedIn})}),/*#__PURE__*/_jsx(Route,{path:\"*\",element:/*#__PURE__*/_jsx(NotFoundPage,{})})]})]}),/*#__PURE__*/_jsx(Footer,{})]})});}export default App;// Страницы:\n// - главная\n// - каталог\n// - страница товара\n// - личный кабинет\n// - корзина\n// - оформление заказа\n// - избранное\n// - покупки (заказы)\n// - регистрация\n// - авторизация","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}